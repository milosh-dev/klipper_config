#################################
# BTT Smart Filament Sensor
#################################
[filament_motion_sensor BBT]
detection_length: 7.00 ; This can be adjusted to your desired level of sensitivity. 10 is a recommended value to prevent flow dropoff false triggers.
extruder: extruder
switch_pin: ^RUNOUT_SENSOR
pause_on_runout: True ; This can be set to false to debug false positives putting the sensor in "monitor mode". The printer will not pause but it will run the runout_gcode below.
event_delay: 3.0
pause_delay: 0.5
runout_gcode:
    _BBT_ON_RUNOUT

[delayed_gcode _DISABLEFILAMENTSENSOR] ; This will disable the SFS 1 second after klipper starts
initial_duration: 1
gcode:
    SET_FILAMENT_SENSOR SENSOR=BBT ENABLE=0 ; Put your filament sensor's name after SENSOR=

[gcode_macro _BBT_ENABLE] ; Add this to PRINT_START
description: Enable smart filament sensor
gcode:
    M117 ENABLING the Smart Filament Sensor
    G92 E0
    SET_FILAMENT_SENSOR SENSOR=BBT ENABLE=1 ; Put your filament sensor's name after SENSOR=

[gcode_macro _BBT_DISABLE] ; Add this to PRINT_END and PRINT_CANCEL
description: Disable smart filament sensor
gcode:
    M117 DISABLING the Smart Filament Sensor
    G92 E0
    SET_FILAMENT_SENSOR SENSOR=BBT ENABLE=0 ; Put your filament sensor's name after SENSOR=

[gcode_macro _BBT_STATE]
description: Internal state for BTT sensor macros
variable_measuring: 0
variable_last_e: 0.0
variable_mode: 0
gcode:

[gcode_macro _BBT_ON_RUNOUT]
description: Handle BTT runout event
gcode:
    {% set measuring = printer["gcode_macro _BBT_STATE"].measuring|int %}
    {% set mode = printer["gcode_macro _BBT_STATE"].mode|int %}
    {% if measuring == 1 %}
        {% set epos = printer.gcode_move.gcode_position.e|float %}
        {% set det = printer.configfile.settings["filament_motion_sensor BBT"].detection_length|default(7.0)|float %}
        {% set length = epos - det %}
        SET_GCODE_VARIABLE MACRO=_BBT_STATE VARIABLE=last_e VALUE={epos}
        SET_GCODE_VARIABLE MACRO=_BBT_STATE VARIABLE=measuring VALUE=0
        SET_GCODE_VARIABLE MACRO=_BBT_STATE VARIABLE=mode VALUE=0
        _NOTIFY MSG="Bowden length approx: { '%.1f' % length } mm (E={ '%.1f' % epos })"
    {% elif mode == 2 %}
        SET_GCODE_VARIABLE MACRO=_BBT_STATE VARIABLE=mode VALUE=0
        { action_respond_info("Filament load stalled. Check path and feeder.") }
    {% elif mode == 3 %}
        SET_GCODE_VARIABLE MACRO=_BBT_STATE VARIABLE=mode VALUE=0
        { action_respond_info("Filament unload stalled. Check path and feeder.") }
    {% else %}
        M117 Filamendi probleem!
        {action_call_remote_method("notify",
            name="pushover",
            message="Filamendiga on mingi probleem!")}
    {% endif %}

[gcode_macro MEASURE_BOWDEN]
description: Extrude until sensor stall; reports approximate Bowden length
gcode:
    {% set L = params.L|default(800)|float %}
    {% set F = params.F|default(1200)|float %}
    SET_GCODE_VARIABLE MACRO=_BBT_STATE VARIABLE=measuring VALUE=1
    SET_GCODE_VARIABLE MACRO=_BBT_STATE VARIABLE=last_e VALUE=0
    SET_FILAMENT_SENSOR SENSOR=BBT ENABLE=1
    M83
    G92 E0
    G1 E{L} F{F}

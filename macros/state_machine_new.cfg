############################################
# My printer filament commands
# 
# Raoul Lattemae
# 
# Initial idea is based on:
#   https://www.reddit.com/r/klippers/comments/m57iai/mom_my_overpowered_m600_command/
# 
# v1.0 - 10.04.2022
# v2.0 - 10.10.2025 (refactored with the help of chatGPT)
############################################

################################################################################
# M876
# Handles prompt response (to communicate with Klipper)

# Point on selles, et olen korduvalt kriipinud printeri plaati, sest
# probe on jäänud sisse.
################################################################################
[gcode_macro M876]
description: Handle responses from the host
variable_myjob: 0
gcode:
	{% set S = params.S|default(-1)|int %}
	{% set myjob = printer["gcode_macro _STATE_MACHINE"].job %}
	{% if  myjob != 0 %}
		
		# Previous
		{% if S == 1 %} 
		    {% set myjob = myjob - 1 %}	
		
		# Next
        {% elif S == 2%}
		    {% set myjob = myjob + 1 %}	
        
		# Skip
        {% elif S == 3%}
		    {% set myjob = myjob + 2 %}	
        
        # _OK
        {% elif S == 4%}
		    {% set myjob = myjob + 1 %}	

        # Cancel
        {% else %}
		    {% set myjob = 0 %}	
        {% endif %}
          
	{% endif %}
	
    #RESPOND TYPE=echo MSG="Nyyd: {myjob} "
    _STATE_MACHINE NEWJOB={myjob}

################################################################################
# M876 Buttons
# Handles movement between steps
################################################################################
[gcode_macro _PREVIOUS]
gcode:
     M876 S1 
[gcode_macro _EDASI]
gcode:
     M876 S2
[gcode_macro _SKIP]
gcode:
     M876 S3
[gcode_macro _OK]
gcode:
     M876 S4
[gcode_macro _CANCEL]
gcode:
     M876 S5

################################################################################
# STATE_MACHINE
# Handles jobs that require step-by-step approach
################################################################################
[gcode_macro _STATE_MACHINE]
description: State Machine pattern for running stepwise macros
variable_job: 0
gcode:
    {% set newjob = params.NEWJOB|default(0)|int %}
    {% if newjob != 0 %}
        SET_GCODE_VARIABLE MACRO=_STATE_MACHINE VARIABLE=job VALUE={newjob}
    {% endif %}

    {% set job = printer["gcode_macro _STATE_MACHINE"].job %}

    {% if job == 0 %}
        RESPOND TYPE=echo MSG="State machine inactive."
        M117 State: Idle
        SET_GCODE_VARIABLE MACRO=_MENU_STATE VARIABLE=state VALUE="idle"
        RETURN
    {% endif %}

    # Example: Centralized place to tag current menu state
    {% if 100 <= job < 200 %}
        SET_GCODE_VARIABLE MACRO=_MENU_STATE VARIABLE=state VALUE="bed_mesh"
    {% elif 600 <= job < 700 %}
        SET_GCODE_VARIABLE MACRO=_MENU_STATE VARIABLE=state VALUE="filament"
    {% else %}
        SET_GCODE_VARIABLE MACRO=_MENU_STATE VARIABLE=state VALUE="working"
    {% endif %}

    # Now run the appropriate state logic
    {% if job == 100 %}
        M117 Calibrate bed mesh?
        RESPOND TYPE=command MSG=" Click _OK to start calibration. "
        RESPOND TYPE=command MSG=" Click _SKIP to skip."
    {% elif job == 101 %}
        M117 Deploy probe
        DEPLOY_PROBE NEXTJOB=103
    {% elif job == 102 %}
        M117 Stow probe
        STOW_PROBE NEXTJOB=104
    {% elif job == 103 %}
        M117 Calibrating bed
        M109 S25
        BED_MESH_CALIBRATE PROFILE=printing
        BED_MESH_PROFILE LOAD=printing
        M117 Bed calibrated
        RESPOND TYPE=command MSG=" Click _OK to continue."
    {% elif job == 104 %}
        M117 Heating for print
        G90
        G1 X0 Y124 Z15 F6000
        M140 S{printer["gcode_macro PRINT_START"].bed}
        M190 S{printer["gcode_macro PRINT_START"].bed}
        M104 S160
        M109 S160
        G92 E0
        M104 S{printer["gcode_macro PRINT_START"].extruder}
        G1 X0 Y140 Z0.5 F500
        M109 S{printer["gcode_macro PRINT_START"].extruder}
        M117 Starting print
    {% else %}
        RESPOND TYPE=echo MSG="No action defined for job {job}"
        M117 Unknown job step
    {% endif %}

################################################################################
# Optional Helper Macro – _MENU_STATE
# We’ll use this one to track which “menu page” should be shown.
################################################################################
[gcode_macro _MENU_STATE]
description: Holds current menu view state
variable_state: idle
gcode:
    {% set newstate = params.STATE|default("") %}
    {% if newstate != "" %}
        SET_GCODE_VARIABLE MACRO=_MENU_STATE VARIABLE=state VALUE={newstate}
    {% endif %}

################################################################################
# Example: Filament Change Menu (Only When Job is in 600–699)
################################################################################
[menu __filament_change]
type: list
name: Filament Change
show: printer["gcode_macro _MENU_STATE"].state == "filament"

items:
    - name: OK
      gcode: _OK
    - name: Skip
      gcode: _SKIP
    - name: Next
      gcode: _EDASI
    - name: Cancel
      gcode: _CANCEL
    - name: ..
      gcode:
        SET_GCODE_VARIABLE MACRO=_STATE_MACHINE VARIABLE=job VALUE=0
        SET_GCODE_VARIABLE MACRO=_MENU_STATE VARIABLE=state VALUE="idle"
################################################################################
# Example: Bed Mesh Menu
################################################################################
[menu __bed_mesh]
type: list
name: Bed Mesh Calibration
show: printer["gcode_macro _MENU_STATE"].state == "bed_mesh"

items:
    - name: OK
      gcode: _OK
    - name: Skip
      gcode: _SKIP
    - name: ..
      gcode:
        SET_GCODE_VARIABLE MACRO=_STATE_MACHINE VARIABLE=job VALUE=0
        SET_GCODE_VARIABLE MACRO=_MENU_STATE VARIABLE=state VALUE="idle"

################################################################################
# Example: Bed Mesh Menu
################################################################################
[menu __main __statemachine]
type: list
name: State Machine
items:
    - name: Current State
      gcode:
        M117 Menu: {printer["gcode_macro _MENU_STATE"].state}
